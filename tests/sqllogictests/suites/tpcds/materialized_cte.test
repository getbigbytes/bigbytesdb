statement ok
set sandbox_tenant = 'test_tenant';

statement ok
use tpcds;

# Q1
query I
WITH customer_total_return AS materialized
  (SELECT sr_customer_sk AS ctr_customer_sk,
          sr_store_sk AS ctr_store_sk,
          sum(sr_return_amt) AS ctr_total_return
   FROM store_returns,
        date_dim
   WHERE sr_returned_date_sk = d_date_sk
     AND d_year = 2000
   GROUP BY sr_customer_sk,
            sr_store_sk)
SELECT c_customer_id
FROM customer_total_return ctr1,
     store,
     customer
WHERE ctr1.ctr_total_return >
    (SELECT avg(ctr_total_return)*1.2
     FROM customer_total_return ctr2
     WHERE ctr1.ctr_store_sk = ctr2.ctr_store_sk)
  AND s_store_sk = ctr1.ctr_store_sk
  AND s_state = 'TN'
  AND ctr1.ctr_customer_sk = c_customer_sk
ORDER BY c_customer_id
LIMIT 100;
----
AAAAAAAAAACAAAAA
AAAAAAAAAGBAAAAA
AAAAAAAAAHCAAAAA
AAAAAAAAAICAAAAA
AAAAAAAAAKCAAAAA
AAAAAAAAAKDAAAAA
AAAAAAAAALBAAAAA
AAAAAAAAANBAAAAA
AAAAAAAAAPCAAAAA
AAAAAAAABEAAAAAA
AAAAAAAABGBAAAAA
AAAAAAAABGDAAAAA
AAAAAAAABMBAAAAA
AAAAAAAABMDAAAAA
AAAAAAAABNCAAAAA
AAAAAAAACDDAAAAA
AAAAAAAACEBAAAAA
AAAAAAAACECAAAAA
AAAAAAAACFDAAAAA
AAAAAAAACGBAAAAA
AAAAAAAACHBAAAAA
AAAAAAAACNDAAAAA
AAAAAAAADEBAAAAA
AAAAAAAADEDAAAAA
AAAAAAAADFAAAAAA
AAAAAAAADFCAAAAA
AAAAAAAADIBAAAAA
AAAAAAAADNAAAAAA
AAAAAAAADOCAAAAA
AAAAAAAAEBAAAAAA
AAAAAAAAEBBAAAAA
AAAAAAAAECBAAAAA
AAAAAAAAEKAAAAAA
AAAAAAAAEPBAAAAA
AAAAAAAAFCAAAAAA
AAAAAAAAFJAAAAAA
AAAAAAAAFJCAAAAA
AAAAAAAAFMCAAAAA
AAAAAAAAFPBAAAAA
AAAAAAAAGAAAAAAA
AAAAAAAAGBBAAAAA
AAAAAAAAGOBAAAAA
AAAAAAAAHEBAAAAA
AAAAAAAAHHDAAAAA
AAAAAAAAHICAAAAA
AAAAAAAAHLDAAAAA
AAAAAAAAHNCAAAAA
AAAAAAAAICAAAAAA
AAAAAAAAIFDAAAAA
AAAAAAAAIIAAAAAA
AAAAAAAAIMAAAAAA
AAAAAAAAINAAAAAA
AAAAAAAAIOAAAAAA
AAAAAAAAIODAAAAA
AAAAAAAAJCCAAAAA
AAAAAAAAJFBAAAAA
AAAAAAAAJFCAAAAA
AAAAAAAAJKAAAAAA
AAAAAAAAJMDAAAAA
AAAAAAAAKADAAAAA
AAAAAAAAKBAAAAAA
AAAAAAAAKCDAAAAA
AAAAAAAAKECAAAAA
AAAAAAAAKGDAAAAA
AAAAAAAAKHBAAAAA
AAAAAAAAKJAAAAAA
AAAAAAAAKJCAAAAA
AAAAAAAAKJDAAAAA
AAAAAAAAKNAAAAAA
AAAAAAAALABAAAAA
AAAAAAAALBCAAAAA
AAAAAAAALCAAAAAA
AAAAAAAALCDAAAAA
AAAAAAAALFAAAAAA
AAAAAAAALFCAAAAA
AAAAAAAALLCAAAAA
AAAAAAAALNBAAAAA
AAAAAAAAMAAAAAAA
AAAAAAAAMABAAAAA
AAAAAAAAMACAAAAA
AAAAAAAAMBBAAAAA
AAAAAAAAMBCAAAAA
AAAAAAAAMGCAAAAA
AAAAAAAAMHCAAAAA
AAAAAAAAMJAAAAAA
AAAAAAAAMJDAAAAA
AAAAAAAANBCAAAAA
AAAAAAAANBDAAAAA
AAAAAAAANCAAAAAA
AAAAAAAANDCAAAAA
AAAAAAAANLAAAAAA
AAAAAAAANLBAAAAA
AAAAAAAANMAAAAAA
AAAAAAAANMBAAAAA
AAAAAAAAODCAAAAA
AAAAAAAAOIAAAAAA
AAAAAAAAOIDAAAAA
AAAAAAAAONBAAAAA
AAAAAAAAONCAAAAA
AAAAAAAAOOAAAAAA

query I
WITH results AS materialized
  (SELECT i_item_id,
          s_state,
          0 AS g_state,
          ss_quantity agg1,
          ss_list_price agg2,
          ss_coupon_amt agg3,
          ss_sales_price agg4
   FROM store_sales,
        customer_demographics,
        date_dim,
        store,
        item
   WHERE ss_sold_date_sk = d_date_sk
     AND ss_item_sk = i_item_sk
     AND ss_store_sk = s_store_sk
     AND ss_cdemo_sk = cd_demo_sk
     AND cd_gender = 'M'
     AND cd_marital_status = 'S'
     AND cd_education_status = 'College'
     AND d_year = 2002
     AND s_state = 'TN' )
SELECT i_item_id,
       s_state,
       g_state,
       agg1,
       agg2,
       agg3,
       agg4
FROM
  ( SELECT i_item_id,
           s_state,
           0 AS g_state,
           avg(agg1) agg1,
           avg(agg2) agg2,
           avg(agg3) agg3,
           avg(agg4) agg4
   FROM results
   GROUP BY i_item_id ,
            s_state
   ) foo
ORDER BY i_item_id NULLS FIRST,
         s_state NULLS FIRST
LIMIT 100;
----
AAAAAAAAACAAAAAA TN 0 54.0 107.97000000 0.00000000 0.00000000
AAAAAAAAAEAAAAAA TN 0 91.0 63.95000000 0.00000000 14.06000000
AAAAAAAAAHAAAAAA TN 0 66.5 59.53500000 2542.45000000 47.70000000
AAAAAAAAAIAAAAAA TN 0 75.0 124.31000000 2580.60000000 74.86500000
AAAAAAAAAKAAAAAA TN 0 36.0 68.50333333 0.00000000 50.50333333
AAAAAAAAALAAAAAA TN 0 85.0 25.24000000 0.00000000 3.53000000
AAAAAAAACCAAAAAA TN 0 40.0 90.50500000 365.38000000 23.32500000
AAAAAAAACDAAAAAA TN 0 22.666666666666668 167.21000000 189.36000000 123.85000000
AAAAAAAACFAAAAAA TN 0 93.0 99.48000000 0.00000000 38.79000000
AAAAAAAACIAAAAAA TN 0 44.0 96.88333333 0.00000000 66.72666667
AAAAAAAACJAAAAAA TN 0 23.0 103.96000000 0.00000000 35.17500000
AAAAAAAACLAAAAAA TN 0 1.0 99.21000000 0.00000000 23.81000000
AAAAAAAADBAAAAAA TN 0 2.0 59.54000000 0.00000000 57.75000000
AAAAAAAADEAAAAAA TN 0 20.666666666666668 50.21000000 2.52333333 16.22333333
AAAAAAAADHAAAAAA TN 0 54.0 72.46000000 0.00000000 23.18000000
AAAAAAAADKAAAAAA TN 0 57.0 116.65000000 0.00000000 116.65000000
AAAAAAAAEAAAAAAA TN 0 96.0 18.88000000 0.00000000 0.18000000
AAAAAAAAEBAAAAAA TN 0 89.0 72.02000000 198.64000000 3.60000000
AAAAAAAAEEAAAAAA TN 0 65.66666666666667 72.09666667 0.00000000 36.22000000
AAAAAAAAEHAAAAAA TN 0 47.0 103.80500000 0.00000000 50.52500000
AAAAAAAAEJAAAAAA TN 0 41.5 74.63500000 148.83000000 21.26000000
AAAAAAAAEKAAAAAA TN 0 53.0 78.36000000 0.00000000 13.32000000
AAAAAAAAFCAAAAAA TN 0 58.0 31.99666667 0.80333333 8.70666667
AAAAAAAAFIAAAAAA TN 0 61.5 106.53000000 0.00000000 38.92000000
AAAAAAAAGCAAAAAA TN 0 96.0 68.02000000 0.00000000 14.28000000
AAAAAAAAGHAAAAAA TN 0 89.0 68.05000000 499.29000000 7.48000000
AAAAAAAAHDAAAAAA TN 0 62.0 93.63000000 0.00000000 3.74000000
AAAAAAAAHJAAAAAA TN 0 76.33333333333333 88.60333333 471.82666667 40.75000000
AAAAAAAAIAAAAAAA TN 0 63.0 89.88000000 0.00000000 70.10000000
AAAAAAAAICAAAAAA TN 0 9.0 84.66000000 0.00000000 11.85000000
AAAAAAAAIDAAAAAA TN 0 87.0 9.48000000 0.00000000 7.20000000
AAAAAAAAIGAAAAAA TN 0 66.0 23.59000000 0.00000000 11.08000000
AAAAAAAAIIAAAAAA TN 0 20.0 68.85000000 0.00000000 53.70000000
AAAAAAAAJKAAAAAA TN 0 97.0 39.45000000 0.00000000 24.06000000
AAAAAAAAKAAAAAAA TN 0 56.0 64.04000000 0.00000000 61.47000000
AAAAAAAAKDAAAAAA TN 0 36.0 31.77000000 0.00000000 30.18000000
AAAAAAAALCAAAAAA TN 0 34.0 147.08000000 1912.65000000 125.01000000
AAAAAAAAMBAAAAAA TN 0 60.0 71.13000000 0.00000000 11.38000000
AAAAAAAAMCAAAAAA TN 0 55.666666666666664 38.22333333 436.18666667 21.22666667
AAAAAAAAMEAAAAAA TN 0 55.5 150.41000000 0.00000000 107.43500000
AAAAAAAAMFAAAAAA TN 0 10.0 97.69000000 0.00000000 93.78000000
AAAAAAAAMHAAAAAA TN 0 48.0 59.96500000 0.00000000 15.91000000
AAAAAAAANAAAAAAA TN 0 65.5 70.54000000 0.00000000 68.42000000
AAAAAAAANDAAAAAA TN 0 88.0 162.72000000 0.00000000 60.20000000
AAAAAAAANGAAAAAA TN 0 27.666666666666668 92.24666667 201.94333333 78.62000000
AAAAAAAAOAAAAAAA TN 0 6.0 22.97000000 0.00000000 12.86000000
AAAAAAAAOCAAAAAA TN 0 76.0 50.88000000 0.00000000 30.01000000
AAAAAAAAODAAAAAA TN 0 26.0 100.08500000 0.00000000 73.23500000
AAAAAAAAOFAAAAAA TN 0 68.0 94.62000000 2432.08000000 39.74000000
AAAAAAAAOIAAAAAA TN 0 17.0 25.93000000 0.00000000 23.59000000
AAAAAAAAOJAAAAAA TN 0 26.0 150.28000000 0.00000000 34.56000000
AAAAAAAAPEAAAAAA TN 0 96.0 72.96000000 0.00000000 29.91000000
AAAAAAAAPHAAAAAA TN 0 58.0 95.50000000 0.00000000 20.05000000
AAAAAAAAPKAAAAAA TN 0 57.5 99.25000000 21.85500000 21.01500000

query I
WITH results AS materialized
  (SELECT i_item_id,
          s_state,
          0 AS g_state,
          ss_quantity agg1,
          ss_list_price agg2,
          ss_coupon_amt agg3,
          ss_sales_price agg4
   FROM store_sales,
        customer_demographics,
        date_dim,
        store,
        item
   WHERE ss_sold_date_sk = d_date_sk
     AND ss_item_sk = i_item_sk
     AND ss_store_sk = s_store_sk
     AND ss_cdemo_sk = cd_demo_sk
     AND cd_gender = 'M'
     AND cd_marital_status = 'S'
     AND cd_education_status = 'College'
     AND d_year = 2002
     AND s_state = 'TN' )
SELECT i_item_id,
       s_state,
       g_state,
       agg1,
       agg2,
       agg3,
       agg4
FROM
  ( SELECT i_item_id,
           s_state,
           0 AS g_state,
           avg(agg1) agg1,
           avg(agg2) agg2,
           avg(agg3) agg3,
           avg(agg4) agg4
   FROM results
   GROUP BY i_item_id ,
            s_state
   UNION ALL SELECT i_item_id,
                    NULL AS s_state,
                    1 AS g_state,
                    avg(agg1) agg1,
                    avg(agg2) agg2,
                    avg(agg3) agg3,
                    avg(agg4) agg4
   FROM results
   GROUP BY i_item_id
   UNION ALL SELECT NULL AS i_item_id,
                    NULL AS s_state,
                    1 AS g_state,
                    avg(agg1) agg1,
                    avg(agg2) agg2,
                    avg(agg3) agg3,
                    avg(agg4) agg4
   FROM results ) foo
ORDER BY i_item_id NULLS FIRST,
         s_state NULLS FIRST
LIMIT 100;
----
NULL NULL 1 51.535714285714285 81.57047619 241.29547619 42.32321429
AAAAAAAAACAAAAAA NULL 1 54.0 107.97000000 0.00000000 0.00000000
AAAAAAAAACAAAAAA TN 0 54.0 107.97000000 0.00000000 0.00000000
AAAAAAAAAEAAAAAA NULL 1 91.0 63.95000000 0.00000000 14.06000000
AAAAAAAAAEAAAAAA TN 0 91.0 63.95000000 0.00000000 14.06000000
AAAAAAAAAHAAAAAA NULL 1 66.5 59.53500000 2542.45000000 47.70000000
AAAAAAAAAHAAAAAA TN 0 66.5 59.53500000 2542.45000000 47.70000000
AAAAAAAAAIAAAAAA NULL 1 75.0 124.31000000 2580.60000000 74.86500000
AAAAAAAAAIAAAAAA TN 0 75.0 124.31000000 2580.60000000 74.86500000
AAAAAAAAAKAAAAAA NULL 1 36.0 68.50333333 0.00000000 50.50333333
AAAAAAAAAKAAAAAA TN 0 36.0 68.50333333 0.00000000 50.50333333
AAAAAAAAALAAAAAA NULL 1 85.0 25.24000000 0.00000000 3.53000000
AAAAAAAAALAAAAAA TN 0 85.0 25.24000000 0.00000000 3.53000000
AAAAAAAACCAAAAAA NULL 1 40.0 90.50500000 365.38000000 23.32500000
AAAAAAAACCAAAAAA TN 0 40.0 90.50500000 365.38000000 23.32500000
AAAAAAAACDAAAAAA NULL 1 22.666666666666668 167.21000000 189.36000000 123.85000000
AAAAAAAACDAAAAAA TN 0 22.666666666666668 167.21000000 189.36000000 123.85000000
AAAAAAAACFAAAAAA NULL 1 93.0 99.48000000 0.00000000 38.79000000
AAAAAAAACFAAAAAA TN 0 93.0 99.48000000 0.00000000 38.79000000
AAAAAAAACIAAAAAA NULL 1 44.0 96.88333333 0.00000000 66.72666667
AAAAAAAACIAAAAAA TN 0 44.0 96.88333333 0.00000000 66.72666667
AAAAAAAACJAAAAAA NULL 1 23.0 103.96000000 0.00000000 35.17500000
AAAAAAAACJAAAAAA TN 0 23.0 103.96000000 0.00000000 35.17500000
AAAAAAAACLAAAAAA NULL 1 1.0 99.21000000 0.00000000 23.81000000
AAAAAAAACLAAAAAA TN 0 1.0 99.21000000 0.00000000 23.81000000
AAAAAAAADBAAAAAA NULL 1 2.0 59.54000000 0.00000000 57.75000000
AAAAAAAADBAAAAAA TN 0 2.0 59.54000000 0.00000000 57.75000000
AAAAAAAADEAAAAAA NULL 1 20.666666666666668 50.21000000 2.52333333 16.22333333
AAAAAAAADEAAAAAA TN 0 20.666666666666668 50.21000000 2.52333333 16.22333333
AAAAAAAADHAAAAAA NULL 1 54.0 72.46000000 0.00000000 23.18000000
AAAAAAAADHAAAAAA TN 0 54.0 72.46000000 0.00000000 23.18000000
AAAAAAAADKAAAAAA NULL 1 57.0 116.65000000 0.00000000 116.65000000
AAAAAAAADKAAAAAA TN 0 57.0 116.65000000 0.00000000 116.65000000
AAAAAAAAEAAAAAAA NULL 1 96.0 18.88000000 0.00000000 0.18000000
AAAAAAAAEAAAAAAA TN 0 96.0 18.88000000 0.00000000 0.18000000
AAAAAAAAEBAAAAAA NULL 1 89.0 72.02000000 198.64000000 3.60000000
AAAAAAAAEBAAAAAA TN 0 89.0 72.02000000 198.64000000 3.60000000
AAAAAAAAEEAAAAAA NULL 1 65.66666666666667 72.09666667 0.00000000 36.22000000
AAAAAAAAEEAAAAAA TN 0 65.66666666666667 72.09666667 0.00000000 36.22000000
AAAAAAAAEHAAAAAA NULL 1 47.0 103.80500000 0.00000000 50.52500000
AAAAAAAAEHAAAAAA TN 0 47.0 103.80500000 0.00000000 50.52500000
AAAAAAAAEJAAAAAA NULL 1 41.5 74.63500000 148.83000000 21.26000000
AAAAAAAAEJAAAAAA TN 0 41.5 74.63500000 148.83000000 21.26000000
AAAAAAAAEKAAAAAA NULL 1 53.0 78.36000000 0.00000000 13.32000000
AAAAAAAAEKAAAAAA TN 0 53.0 78.36000000 0.00000000 13.32000000
AAAAAAAAFCAAAAAA NULL 1 58.0 31.99666667 0.80333333 8.70666667
AAAAAAAAFCAAAAAA TN 0 58.0 31.99666667 0.80333333 8.70666667
AAAAAAAAFIAAAAAA NULL 1 61.5 106.53000000 0.00000000 38.92000000
AAAAAAAAFIAAAAAA TN 0 61.5 106.53000000 0.00000000 38.92000000
AAAAAAAAGCAAAAAA NULL 1 96.0 68.02000000 0.00000000 14.28000000
AAAAAAAAGCAAAAAA TN 0 96.0 68.02000000 0.00000000 14.28000000
AAAAAAAAGHAAAAAA NULL 1 89.0 68.05000000 499.29000000 7.48000000
AAAAAAAAGHAAAAAA TN 0 89.0 68.05000000 499.29000000 7.48000000
AAAAAAAAHDAAAAAA NULL 1 62.0 93.63000000 0.00000000 3.74000000
AAAAAAAAHDAAAAAA TN 0 62.0 93.63000000 0.00000000 3.74000000
AAAAAAAAHJAAAAAA NULL 1 76.33333333333333 88.60333333 471.82666667 40.75000000
AAAAAAAAHJAAAAAA TN 0 76.33333333333333 88.60333333 471.82666667 40.75000000
AAAAAAAAIAAAAAAA NULL 1 63.0 89.88000000 0.00000000 70.10000000
AAAAAAAAIAAAAAAA TN 0 63.0 89.88000000 0.00000000 70.10000000
AAAAAAAAICAAAAAA NULL 1 9.0 84.66000000 0.00000000 11.85000000
AAAAAAAAICAAAAAA TN 0 9.0 84.66000000 0.00000000 11.85000000
AAAAAAAAIDAAAAAA NULL 1 87.0 9.48000000 0.00000000 7.20000000
AAAAAAAAIDAAAAAA TN 0 87.0 9.48000000 0.00000000 7.20000000
AAAAAAAAIGAAAAAA NULL 1 66.0 23.59000000 0.00000000 11.08000000
AAAAAAAAIGAAAAAA TN 0 66.0 23.59000000 0.00000000 11.08000000
AAAAAAAAIIAAAAAA NULL 1 20.0 68.85000000 0.00000000 53.70000000
AAAAAAAAIIAAAAAA TN 0 20.0 68.85000000 0.00000000 53.70000000
AAAAAAAAJKAAAAAA NULL 1 97.0 39.45000000 0.00000000 24.06000000
AAAAAAAAJKAAAAAA TN 0 97.0 39.45000000 0.00000000 24.06000000
AAAAAAAAKAAAAAAA NULL 1 56.0 64.04000000 0.00000000 61.47000000
AAAAAAAAKAAAAAAA TN 0 56.0 64.04000000 0.00000000 61.47000000
AAAAAAAAKDAAAAAA NULL 1 36.0 31.77000000 0.00000000 30.18000000
AAAAAAAAKDAAAAAA TN 0 36.0 31.77000000 0.00000000 30.18000000
AAAAAAAALCAAAAAA NULL 1 34.0 147.08000000 1912.65000000 125.01000000
AAAAAAAALCAAAAAA TN 0 34.0 147.08000000 1912.65000000 125.01000000
AAAAAAAAMBAAAAAA NULL 1 60.0 71.13000000 0.00000000 11.38000000
AAAAAAAAMBAAAAAA TN 0 60.0 71.13000000 0.00000000 11.38000000
AAAAAAAAMCAAAAAA NULL 1 55.666666666666664 38.22333333 436.18666667 21.22666667
AAAAAAAAMCAAAAAA TN 0 55.666666666666664 38.22333333 436.18666667 21.22666667
AAAAAAAAMEAAAAAA NULL 1 55.5 150.41000000 0.00000000 107.43500000
AAAAAAAAMEAAAAAA TN 0 55.5 150.41000000 0.00000000 107.43500000
AAAAAAAAMFAAAAAA NULL 1 10.0 97.69000000 0.00000000 93.78000000
AAAAAAAAMFAAAAAA TN 0 10.0 97.69000000 0.00000000 93.78000000
AAAAAAAAMHAAAAAA NULL 1 48.0 59.96500000 0.00000000 15.91000000
AAAAAAAAMHAAAAAA TN 0 48.0 59.96500000 0.00000000 15.91000000
AAAAAAAANAAAAAAA NULL 1 65.5 70.54000000 0.00000000 68.42000000
AAAAAAAANAAAAAAA TN 0 65.5 70.54000000 0.00000000 68.42000000
AAAAAAAANDAAAAAA NULL 1 88.0 162.72000000 0.00000000 60.20000000
AAAAAAAANDAAAAAA TN 0 88.0 162.72000000 0.00000000 60.20000000
AAAAAAAANGAAAAAA NULL 1 27.666666666666668 92.24666667 201.94333333 78.62000000
AAAAAAAANGAAAAAA TN 0 27.666666666666668 92.24666667 201.94333333 78.62000000
AAAAAAAAOAAAAAAA NULL 1 6.0 22.97000000 0.00000000 12.86000000
AAAAAAAAOAAAAAAA TN 0 6.0 22.97000000 0.00000000 12.86000000
AAAAAAAAOCAAAAAA NULL 1 76.0 50.88000000 0.00000000 30.01000000
AAAAAAAAOCAAAAAA TN 0 76.0 50.88000000 0.00000000 30.01000000
AAAAAAAAODAAAAAA NULL 1 26.0 100.08500000 0.00000000 73.23500000
AAAAAAAAODAAAAAA TN 0 26.0 100.08500000 0.00000000 73.23500000
AAAAAAAAOFAAAAAA NULL 1 68.0 94.62000000 2432.08000000 39.74000000
AAAAAAAAOFAAAAAA TN 0 68.0 94.62000000 2432.08000000 39.74000000
AAAAAAAAOIAAAAAA NULL 1 17.0 25.93000000 0.00000000 23.59000000

query I
WITH ssr AS materialized
  (SELECT s_store_id,
          sum(sales_price) AS sales,
          sum(profit) AS profit,
          sum(return_amt) AS returns_,
          sum(net_loss) AS profit_loss
   FROM
     (SELECT ss_store_sk AS store_sk,
             ss_sold_date_sk AS date_sk,
             ss_ext_sales_price AS sales_price,
             ss_net_profit AS profit,
             cast(0 AS decimal(7,2)) AS return_amt,
             cast(0 AS decimal(7,2)) AS net_loss
      FROM store_sales
      UNION ALL SELECT sr_store_sk AS store_sk,
                       sr_returned_date_sk AS date_sk,
                       cast(0 AS decimal(7,2)) AS sales_price,
                       cast(0 AS decimal(7,2)) AS profit,
                       sr_return_amt AS return_amt,
                       sr_net_loss AS net_loss
      FROM store_returns ) salesreturns,
        date_dim,
        store
   WHERE date_sk = d_date_sk
     AND d_date BETWEEN cast('2000-08-23' AS date) AND cast('2000-09-06' AS date)
     AND store_sk = s_store_sk
   GROUP BY s_store_id) ,
     csr AS materialized
  (SELECT cp_catalog_page_id,
          sum(sales_price) AS sales,
          sum(profit) AS profit,
          sum(return_amt) AS returns_,
          sum(net_loss) AS profit_loss
   FROM
     (SELECT cs_catalog_page_sk AS page_sk,
             cs_sold_date_sk AS date_sk,
             cs_ext_sales_price AS sales_price,
             cs_net_profit AS profit,
             cast(0 AS decimal(7,2)) AS return_amt,
             cast(0 AS decimal(7,2)) AS net_loss
      FROM catalog_sales
      UNION ALL SELECT cr_catalog_page_sk AS page_sk,
                       cr_returned_date_sk AS date_sk,
                       cast(0 AS decimal(7,2)) AS sales_price,
                       cast(0 AS decimal(7,2)) AS profit,
                       cr_return_amount AS return_amt,
                       cr_net_loss AS net_loss
      FROM catalog_returns ) salesreturns,
        date_dim,
        catalog_page
   WHERE date_sk = d_date_sk
     AND d_date BETWEEN cast('2000-08-23' AS date) AND cast('2000-09-06' AS date)
     AND page_sk = cp_catalog_page_sk
   GROUP BY cp_catalog_page_id) ,
     wsr AS materialized
  (SELECT web_site_id,
          sum(sales_price) AS sales,
          sum(profit) AS profit,
          sum(return_amt) AS returns_,
          sum(net_loss) AS profit_loss
   FROM
     (SELECT ws_web_site_sk AS wsr_web_site_sk,
             ws_sold_date_sk AS date_sk,
             ws_ext_sales_price AS sales_price,
             ws_net_profit AS profit,
             cast(0 AS decimal(7,2)) AS return_amt,
             cast(0 AS decimal(7,2)) AS net_loss
      FROM web_sales
      UNION ALL SELECT ws_web_site_sk AS wsr_web_site_sk,
                       wr_returned_date_sk AS date_sk,
                       cast(0 AS decimal(7,2)) AS sales_price,
                       cast(0 AS decimal(7,2)) AS profit,
                       wr_return_amt AS return_amt,
                       wr_net_loss AS net_loss
      FROM web_returns
      LEFT OUTER JOIN web_sales ON (wr_item_sk = ws_item_sk
                                    AND wr_order_number = ws_order_number) ) salesreturns,
        date_dim,
        web_site
   WHERE date_sk = d_date_sk
     AND d_date BETWEEN cast('2000-08-23' AS date) AND cast('2000-09-06' AS date)
     AND wsr_web_site_sk = web_site_sk
   GROUP BY web_site_id)
SELECT channel ,
       id ,
       sum(sales) AS sales ,
       sum(returns_) AS returns_ ,
       sum(profit) AS profit
FROM
  (SELECT 'store channel' AS channel ,
          concat('store', s_store_id) AS id ,
          sales ,
          returns_ ,
          (profit - profit_loss) AS profit
   FROM ssr
   UNION ALL SELECT 'catalog channel' AS channel ,
                    concat('catalog_page', cp_catalog_page_id) AS id ,
                    sales ,
                    returns_ ,
                    (profit - profit_loss) AS profit
   FROM csr
   UNION ALL SELECT 'web channel' AS channel ,
                    concat('web_site', web_site_id) AS id ,
                    sales ,
                    returns_ ,
                    (profit - profit_loss) AS profit
   FROM wsr ) x
GROUP BY ROLLUP (channel,
                 id)
ORDER BY channel NULLS FIRST,
         id NULLS FIRST
LIMIT 100;
----
NULL NULL 1235226.36 22228.88 -364862.29
catalog channel NULL 394281.25 9538.33 -37140.33
catalog channel catalog_pageAAAAAAAAAAABAAAA 22.10 0.00 -96.00
catalog channel catalog_pageAAAAAAAAADABAAAA 372.40 0.00 53.79
catalog channel catalog_pageAAAAAAAAAFCBAAAA 626.40 0.00 -322.70
catalog channel catalog_pageAAAAAAAAAGABAAAA 3471.68 0.00 94.24
catalog channel catalog_pageAAAAAAAAAGCBAAAA 1891.89 0.00 -143.01
catalog channel catalog_pageAAAAAAAAAHCBAAAA 209.44 0.00 -5017.32
catalog channel catalog_pageAAAAAAAAAKPAAAAA 5304.00 0.00 735.20
catalog channel catalog_pageAAAAAAAAALPAAAAA 865.83 0.00 -695.97
catalog channel catalog_pageAAAAAAAAAOPAAAAA 7910.58 0.00 2044.14
catalog channel catalog_pageAAAAAAAABCABAAAA 3670.04 0.00 96.90
catalog channel catalog_pageAAAAAAAABDCBAAAA 4873.60 0.00 -84.62
catalog channel catalog_pageAAAAAAAABEABAAAA 16.80 0.00 -852.32
catalog channel catalog_pageAAAAAAAABFCBAAAA 627.36 0.00 42.36
catalog channel catalog_pageAAAAAAAABGABAAAA 3198.72 0.00 -3482.88
catalog channel catalog_pageAAAAAAAABHABAAAA 6152.40 0.00 972.90
catalog channel catalog_pageAAAAAAAABICBAAAA 150.90 0.00 -168.00
catalog channel catalog_pageAAAAAAAABLPAAAAA 5389.93 0.00 1362.50
catalog channel catalog_pageAAAAAAAACLPAAAAA 4581.66 0.00 820.04
catalog channel catalog_pageAAAAAAAACNCBAAAA 1537.38 0.00 -127.14
catalog channel catalog_pageAAAAAAAACNPAAAAA 2220.63 0.00 18.93
catalog channel catalog_pageAAAAAAAACOPAAAAA 9989.74 0.00 -83.60
catalog channel catalog_pageAAAAAAAACPPAAAAA 5447.76 0.00 786.97
catalog channel catalog_pageAAAAAAAADAABAAAA 1026.12 0.00 -2620.72
catalog channel catalog_pageAAAAAAAADBABAAAA 980.56 0.00 334.56
catalog channel catalog_pageAAAAAAAADEABAAAA 306.36 0.00 -275.65
catalog channel catalog_pageAAAAAAAADGABAAAA 7812.09 0.00 253.44
catalog channel catalog_pageAAAAAAAADGCBAAAA 330.60 0.00 -2791.10
catalog channel catalog_pageAAAAAAAADHABAAAA 1340.02 0.00 -316.14
catalog channel catalog_pageAAAAAAAADHPAAAAA 0.00 6954.50 -3284.09
catalog channel catalog_pageAAAAAAAADICBAAAA 5996.07 0.00 1360.17
catalog channel catalog_pageAAAAAAAADMPAAAAA 4181.33 0.00 513.30
catalog channel catalog_pageAAAAAAAADPPAAAAA 3313.75 0.00 -933.35
catalog channel catalog_pageAAAAAAAAEDABAAAA 3383.12 0.00 1440.92
catalog channel catalog_pageAAAAAAAAEDCBAAAA 581.94 0.00 -4024.82
catalog channel catalog_pageAAAAAAAAEECBAAAA 3658.50 0.00 2188.00
catalog channel catalog_pageAAAAAAAAEFCBAAAA 145.53 0.00 -469.63
catalog channel catalog_pageAAAAAAAAEGCBAAAA 9481.50 0.00 1839.00
catalog channel catalog_pageAAAAAAAAEHCBAAAA 1307.34 0.00 -2548.26
catalog channel catalog_pageAAAAAAAAEKPAAAAA 897.60 0.00 342.72
catalog channel catalog_pageAAAAAAAAELPAAAAA 14863.14 0.00 8761.40
catalog channel catalog_pageAAAAAAAAEMPAAAAA 209.56 0.00 -2501.94
catalog channel catalog_pageAAAAAAAAEOPAAAAA 2343.94 0.00 -2434.00
catalog channel catalog_pageAAAAAAAAEPPAAAAA 7316.92 0.00 -1759.63
catalog channel catalog_pageAAAAAAAAFAABAAAA 6500.52 0.00 1534.14
catalog channel catalog_pageAAAAAAAAFFABAAAA 614.25 0.00 -91.18
catalog channel catalog_pageAAAAAAAAFGABAAAA 643.20 0.00 62.10
catalog channel catalog_pageAAAAAAAAFGCBAAAA 231.42 0.00 116.10
catalog channel catalog_pageAAAAAAAAFHCBAAAA 721.20 0.00 158.40
catalog channel catalog_pageAAAAAAAAFICBAAAA 244.61 0.00 -437.98
catalog channel catalog_pageAAAAAAAAFMPAAAAA 9426.60 0.00 2692.80
catalog channel catalog_pageAAAAAAAAFOPAAAAA 202.02 0.00 -4314.20
catalog channel catalog_pageAAAAAAAAGAABAAAA 13698.23 0.00 5226.13
catalog channel catalog_pageAAAAAAAAGCCBAAAA 4558.02 0.00 161.77
catalog channel catalog_pageAAAAAAAAGGCBAAAA 25.11 0.00 -1437.78
catalog channel catalog_pageAAAAAAAAGNPAAAAA 2205.64 0.00 1169.82
catalog channel catalog_pageAAAAAAAAHAABAAAA 2695.35 0.00 12.95
catalog channel catalog_pageAAAAAAAAHBABAAAA 2377.98 0.00 264.00
catalog channel catalog_pageAAAAAAAAHCCBAAAA 162.11 0.00 -2316.41
catalog channel catalog_pageAAAAAAAAHDABAAAA 1948.05 0.00 744.75
catalog channel catalog_pageAAAAAAAAHGABAAAA 3490.56 0.00 -39.84
catalog channel catalog_pageAAAAAAAAHGCBAAAA 674.73 0.00 -3149.45
catalog channel catalog_pageAAAAAAAAHHCBAAAA 4625.50 0.00 2380.95
catalog channel catalog_pageAAAAAAAAHIPAAAAA 0.00 1073.70 -689.92
catalog channel catalog_pageAAAAAAAAHMPAAAAA 8269.73 0.00 -4607.62
catalog channel catalog_pageAAAAAAAAHOPAAAAA 8691.99 0.00 -4717.00
catalog channel catalog_pageAAAAAAAAHPCBAAAA 1295.56 0.00 -3035.55
catalog channel catalog_pageAAAAAAAAHPPAAAAA 4579.38 0.00 476.22
catalog channel catalog_pageAAAAAAAAIAABAAAA 7391.20 0.00 2330.40
catalog channel catalog_pageAAAAAAAAIBABAAAA 596.67 0.00 340.02
catalog channel catalog_pageAAAAAAAAIFABAAAA 667.60 0.00 -1763.21
catalog channel catalog_pageAAAAAAAAIFCBAAAA 242.40 0.00 -5386.40
catalog channel catalog_pageAAAAAAAAIICBAAAA 114.76 0.00 -842.08
catalog channel catalog_pageAAAAAAAAIKPAAAAA 1528.02 0.00 384.15
catalog channel catalog_pageAAAAAAAAILPAAAAA 2479.62 0.00 577.20
catalog channel catalog_pageAAAAAAAAIOPAAAAA 53.70 0.00 -324.90
catalog channel catalog_pageAAAAAAAAJAABAAAA 286.56 0.00 -21.12
catalog channel catalog_pageAAAAAAAAJCCBAAAA 430.56 0.00 -212.40
catalog channel catalog_pageAAAAAAAAJFCBAAAA 957.22 0.00 -339.91
catalog channel catalog_pageAAAAAAAAJHCBAAAA 416.25 0.00 75.50
catalog channel catalog_pageAAAAAAAAJKPAAAAA 4.20 0.00 -250.90
catalog channel catalog_pageAAAAAAAAJMPAAAAA 92.70 0.00 17.60
catalog channel catalog_pageAAAAAAAAJOPAAAAA 10521.42 0.00 2877.16
catalog channel catalog_pageAAAAAAAAKAABAAAA 183.60 0.00 -349.35
catalog channel catalog_pageAAAAAAAAKCABAAAA 494.55 0.00 -1750.77
catalog channel catalog_pageAAAAAAAAKDCBAAAA 2497.08 0.00 473.40
catalog channel catalog_pageAAAAAAAAKGABAAAA 132.86 0.00 -771.42
catalog channel catalog_pageAAAAAAAAKHCBAAAA 847.67 0.00 -2819.77
catalog channel catalog_pageAAAAAAAAKKPAAAAA 6799.36 0.00 3336.02
catalog channel catalog_pageAAAAAAAAKLPAAAAA 5040.20 0.00 -3162.45
catalog channel catalog_pageAAAAAAAAKNPAAAAA 3414.00 0.00 2130.40
catalog channel catalog_pageAAAAAAAAKOPAAAAA 7975.00 0.00 4245.00
catalog channel catalog_pageAAAAAAAALAABAAAA 19195.70 0.00 10003.50
catalog channel catalog_pageAAAAAAAALBABAAAA 221.88 0.00 18.40
catalog channel catalog_pageAAAAAAAALECBAAAA 761.36 0.00 -1823.29
catalog channel catalog_pageAAAAAAAALFCBAAAA 2881.80 0.00 691.20
catalog channel catalog_pageAAAAAAAALGABAAAA 747.20 0.00 408.44
catalog channel catalog_pageAAAAAAAALHCBAAAA 712.50 0.00 -250.50
catalog channel catalog_pageAAAAAAAALKPAAAAA 2395.69 0.00 -2898.62

query I
WITH year_total AS materialized
  (SELECT c_customer_id customer_id,
          c_first_name customer_first_name,
          c_last_name customer_last_name,
          c_preferred_cust_flag customer_preferred_cust_flag,
          c_birth_country customer_birth_country,
          c_login customer_login,
          c_email_address customer_email_address,
          d_year dyear,
          sum(ss_ext_list_price-ss_ext_discount_amt) year_total,
          's' sale_type
   FROM customer,
        store_sales,
        date_dim
   WHERE c_customer_sk = ss_customer_sk
     AND ss_sold_date_sk = d_date_sk
   GROUP BY c_customer_id,
            c_first_name,
            c_last_name,
            c_preferred_cust_flag,
            c_birth_country,
            c_login,
            c_email_address,
            d_year
   UNION ALL SELECT c_customer_id customer_id,
                    c_first_name customer_first_name,
                    c_last_name customer_last_name,
                    c_preferred_cust_flag customer_preferred_cust_flag,
                    c_birth_country customer_birth_country,
                    c_login customer_login,
                    c_email_address customer_email_address,
                    d_year dyear,
                    sum(ws_ext_list_price-ws_ext_discount_amt) year_total,
                    'w' sale_type
   FROM customer,
        web_sales,
        date_dim
   WHERE c_customer_sk = ws_bill_customer_sk
     AND ws_sold_date_sk = d_date_sk
   GROUP BY c_customer_id,
            c_first_name,
            c_last_name,
            c_preferred_cust_flag,
            c_birth_country,
            c_login,
            c_email_address,
            d_year)
SELECT t_s_secyear.customer_id,
       t_s_secyear.customer_first_name,
       t_s_secyear.customer_last_name,
       t_s_secyear.customer_preferred_cust_flag
FROM year_total t_s_firstyear,
     year_total t_s_secyear,
     year_total t_w_firstyear,
     year_total t_w_secyear
WHERE t_s_secyear.customer_id = t_s_firstyear.customer_id
  AND t_s_firstyear.customer_id = t_w_secyear.customer_id
  AND t_s_firstyear.customer_id = t_w_firstyear.customer_id
  AND t_s_firstyear.sale_type = 's'
  AND t_w_firstyear.sale_type = 'w'
  AND t_s_secyear.sale_type = 's'
  AND t_w_secyear.sale_type = 'w'
  AND t_s_firstyear.dyear = 2001
  AND t_s_secyear.dyear = 2001+1
  AND t_w_firstyear.dyear = 2001
  AND t_w_secyear.dyear = 2001+1
  AND t_s_firstyear.year_total > 0
  AND t_w_firstyear.year_total > 0
  AND CASE
          WHEN t_w_firstyear.year_total > 0 THEN (t_w_secyear.year_total*1.0000) / t_w_firstyear.year_total
          ELSE 0.0
      END > CASE
                WHEN t_s_firstyear.year_total > 0 THEN (t_s_secyear.year_total*1.0000) / t_s_firstyear.year_total
                ELSE 0.0
            END
ORDER BY t_s_secyear.customer_id NULLS FIRST,
         t_s_secyear.customer_first_name NULLS FIRST,
         t_s_secyear.customer_last_name NULLS FIRST,
         t_s_secyear.customer_preferred_cust_flag NULLS FIRST
LIMIT 100;
----

query I
WITH frequent_ss_items AS materialized
  (SELECT itemdesc,
          i_item_sk item_sk,
          d_date solddate,
          count(*) cnt
   FROM store_sales,
        date_dim,
     (SELECT SUBSTRING(i_item_desc, 1, 30) itemdesc,
             *
      FROM item) sq1
   WHERE ss_sold_date_sk = d_date_sk
     AND ss_item_sk = i_item_sk
     AND d_year IN (2000,
                    2000+1,
                    2000+2,
                    2000+3)
   GROUP BY itemdesc,
            i_item_sk,
            d_date
   HAVING count(*) >4),
     max_store_sales AS materialized
  (SELECT max(csales) tpcds_cmax
   FROM
     (SELECT c_customer_sk,
             sum(ss_quantity*ss_sales_price) csales
      FROM store_sales,
           customer,
           date_dim
      WHERE ss_customer_sk = c_customer_sk
        AND ss_sold_date_sk = d_date_sk
        AND d_year IN (2000,
                       2000+1,
                       2000+2,
                       2000+3)
      GROUP BY c_customer_sk) sq2),
     best_ss_customer AS
  (SELECT c_customer_sk,
          sum(ss_quantity*ss_sales_price) ssales
   FROM store_sales,
        customer,
        max_store_sales
   WHERE ss_customer_sk = c_customer_sk
   GROUP BY c_customer_sk
   HAVING sum(ss_quantity*ss_sales_price) > (50/100.0) * max(tpcds_cmax))
SELECT c_last_name,
       c_first_name,
       sales
FROM
  (SELECT c_last_name,
          c_first_name,
          sum(cs_quantity*cs_list_price) sales
   FROM catalog_sales,
        customer,
        date_dim,
        frequent_ss_items,
        best_ss_customer
   WHERE d_year = 2000
     AND d_moy = 2
     AND cs_sold_date_sk = d_date_sk
     AND cs_item_sk = item_sk
     AND cs_bill_customer_sk = best_ss_customer.c_customer_sk
     AND cs_bill_customer_sk = customer.c_customer_sk
   GROUP BY c_last_name,
            c_first_name
   UNION ALL SELECT c_last_name,
                    c_first_name,
                    sum(ws_quantity*ws_list_price) sales
   FROM web_sales,
        customer,
        date_dim,
        frequent_ss_items,
        best_ss_customer
   WHERE d_year = 2000
     AND d_moy = 2
     AND ws_sold_date_sk = d_date_sk
     AND ws_item_sk = item_sk
     AND ws_bill_customer_sk = best_ss_customer.c_customer_sk
     AND ws_bill_customer_sk = customer.c_customer_sk
   GROUP BY c_last_name,
            c_first_name) sq3
ORDER BY c_last_name NULLS FIRST,
         c_first_name NULLS FIRST,
         sales NULLS FIRST
LIMIT 100;
----

query I
WITH ssales AS materialized
  (SELECT c_last_name,
          c_first_name,
          s_store_name,
          ca_state,
          s_state,
          i_color,
          i_current_price,
          i_manager_id,
          i_units,
          i_size,
          sum(ss_net_paid) netpaid
   FROM store_sales,
        store_returns,
        store,
        item,
        customer,
        customer_address
   WHERE ss_ticket_number = sr_ticket_number
     AND ss_item_sk = sr_item_sk
     AND ss_customer_sk = c_customer_sk
     AND ss_item_sk = i_item_sk
     AND ss_store_sk = s_store_sk
     AND c_current_addr_sk = ca_address_sk
     AND c_birth_country <> upper(ca_country)
     AND s_zip = ca_zip
     AND s_market_id=8
   GROUP BY c_last_name,
            c_first_name,
            s_store_name,
            ca_state,
            s_state,
            i_color,
            i_current_price,
            i_manager_id,
            i_units,
            i_size)
SELECT c_last_name,
       c_first_name,
       s_store_name,
       sum(netpaid) paid
FROM ssales
WHERE i_color = 'peach'
GROUP BY c_last_name,
         c_first_name,
         s_store_name
HAVING sum(netpaid) >
  (SELECT 0.05*avg(netpaid)
   FROM ssales)
ORDER BY c_last_name,
         c_first_name,
         s_store_name ;
----

query I
WITH ss AS materialized
  (SELECT ca_county,
          d_qoy,
          d_year,
          sum(ss_ext_sales_price) AS store_sales
   FROM store_sales,
        date_dim,
        customer_address
   WHERE ss_sold_date_sk = d_date_sk
     AND ss_addr_sk=ca_address_sk
   GROUP BY ca_county,
            d_qoy,
            d_year),
     ws AS materialized
  (SELECT ca_county,
          d_qoy,
          d_year,
          sum(ws_ext_sales_price) AS web_sales
   FROM web_sales,
        date_dim,
        customer_address
   WHERE ws_sold_date_sk = d_date_sk
     AND ws_bill_addr_sk=ca_address_sk
   GROUP BY ca_county,
            d_qoy,
            d_year)
SELECT ss1.ca_county ,
       ss1.d_year ,
       (ws2.web_sales*1.0000)/ws1.web_sales web_q1_q2_increase ,
       (ss2.store_sales*1.0000)/ss1.store_sales store_q1_q2_increase ,
       (ws3.web_sales*1.0000)/ws2.web_sales web_q2_q3_increase ,
       (ss3.store_sales*1.0000)/ss2.store_sales store_q2_q3_increase
FROM ss ss1 ,
     ss ss2 ,
     ss ss3 ,
     ws ws1 ,
     ws ws2 ,
     ws ws3
WHERE ss1.d_qoy = 1
  AND ss1.d_year = 2000
  AND ss1.ca_county = ss2.ca_county
  AND ss2.d_qoy = 2
  AND ss2.d_year = 2000
  AND ss2.ca_county = ss3.ca_county
  AND ss3.d_qoy = 3
  AND ss3.d_year = 2000
  AND ss1.ca_county = ws1.ca_county
  AND ws1.d_qoy = 1
  AND ws1.d_year = 2000
  AND ws1.ca_county = ws2.ca_county
  AND ws2.d_qoy = 2
  AND ws2.d_year = 2000
  AND ws1.ca_county = ws3.ca_county
  AND ws3.d_qoy = 3
  AND ws3.d_year = 2000
  AND CASE
          WHEN ws1.web_sales > 0 THEN (ws2.web_sales*1.0000)/ws1.web_sales
          ELSE NULL
      END > CASE
                WHEN ss1.store_sales > 0 THEN (ss2.store_sales*1.0000)/ss1.store_sales
                ELSE NULL
            END
  AND CASE
          WHEN ws2.web_sales > 0 THEN (ws3.web_sales*1.0000)/ws2.web_sales
          ELSE NULL
      END > CASE
                WHEN ss2.store_sales > 0 THEN (ss3.store_sales*1.0000)/ss2.store_sales
                ELSE NULL
            END
ORDER BY ss1.ca_county;
----

query I
WITH ss AS materialized
  ( SELECT i_manufact_id,
           sum(ss_ext_sales_price) total_sales
   FROM store_sales,
        date_dim,
        customer_address,
        item
   WHERE i_manufact_id IN
       (SELECT i_manufact_id
        FROM item
        WHERE i_category IN ('Electronics'))
     AND ss_item_sk = i_item_sk
     AND ss_sold_date_sk = d_date_sk
     AND d_year = 1998
     AND d_moy = 5
     AND ss_addr_sk = ca_address_sk
     AND ca_gmt_offset = -5
   GROUP BY i_manufact_id),
     cs AS materialized
  ( SELECT i_manufact_id,
           sum(cs_ext_sales_price) total_sales
   FROM catalog_sales,
        date_dim,
        customer_address,
        item
   WHERE i_manufact_id IN
       (SELECT i_manufact_id
        FROM item
        WHERE i_category IN ('Electronics'))
     AND cs_item_sk = i_item_sk
     AND cs_sold_date_sk = d_date_sk
     AND d_year = 1998
     AND d_moy = 5
     AND cs_bill_addr_sk = ca_address_sk
     AND ca_gmt_offset = -5
   GROUP BY i_manufact_id),
     ws AS materialized
  ( SELECT i_manufact_id,
           sum(ws_ext_sales_price) total_sales
   FROM web_sales,
        date_dim,
        customer_address,
        item
   WHERE i_manufact_id IN
       (SELECT i_manufact_id
        FROM item
        WHERE i_category IN ('Electronics'))
     AND ws_item_sk = i_item_sk
     AND ws_sold_date_sk = d_date_sk
     AND d_year = 1998
     AND d_moy = 5
     AND ws_bill_addr_sk = ca_address_sk
     AND ca_gmt_offset = -5
   GROUP BY i_manufact_id)
SELECT i_manufact_id,
       sum(total_sales) total_sales
FROM
  (SELECT *
   FROM ss
   UNION ALL SELECT *
   FROM cs
   UNION ALL SELECT *
   FROM ws) tmp1
GROUP BY i_manufact_id
ORDER BY total_sales
LIMIT 100;
----

query I
WITH results AS materialized
  (SELECT sum(ss_net_profit) AS ss_net_profit,
          sum(ss_ext_sales_price) AS ss_ext_sales_price,
          (sum(ss_net_profit)*1.0000)/sum(ss_ext_sales_price) AS gross_margin ,
          i_category ,
          i_class ,
          0 AS g_category,
          0 AS g_class
   FROM store_sales ,
        date_dim d1 ,
        item ,
        store
   WHERE d1.d_year = 2001
     AND d1.d_date_sk = ss_sold_date_sk
     AND i_item_sk = ss_item_sk
     AND s_store_sk = ss_store_sk
     AND s_state ='TN'
   GROUP BY i_category,
            i_class) ,
     results_rollup AS
  (SELECT gross_margin,
          i_category,
          i_class,
          0 AS t_category,
          0 AS t_class,
          0 AS lochierarchy
   FROM results
   UNION SELECT (sum(ss_net_profit)*1.0000)/sum(ss_ext_sales_price) AS gross_margin,
                i_category,
                NULL AS i_class,
                0 AS t_category,
                1 AS t_class,
                1 AS lochierarchy
   FROM results
   GROUP BY i_category
   UNION SELECT (sum(ss_net_profit)*1.0000)/sum(ss_ext_sales_price) AS gross_margin,
                NULL AS i_category,
                NULL AS i_class,
                1 AS t_category,
                1 AS t_class,
                2 AS lochierarchy
   FROM results)
SELECT gross_margin,
       i_category,
       i_class,
       lochierarchy,
       rank() OVER (PARTITION BY lochierarchy,
                                  CASE
                                      WHEN t_class = 0 THEN i_category
                                  END
                    ORDER BY gross_margin ASC) AS rank_within_parent
FROM results_rollup
ORDER BY lochierarchy DESC NULLS FIRST,
         CASE
             WHEN lochierarchy = 0 THEN i_category
         END NULLS FIRST,
         rank_within_parent NULLS FIRST
LIMIT 100;
----
-0.430613524573 NULL NULL 2 1
-0.539846955888 Electronics NULL 1 1
-0.535121056890 Sports NULL 1 2
-0.474252822435 Men NULL 1 3
-0.435320469694 Music NULL 1 4
-0.422314561478 Books NULL 1 5
-0.420998277520 Women NULL 1 6
-0.403514360940 Jewelry NULL 1 7
-0.356821428448 Children NULL 1 8
-0.314648142539 Home NULL 1 9
-0.289802639400 Shoes NULL 1 10
-0.513324910569 Books sports 0 1
-0.485395658723 Books fiction 0 2
-0.456069178992 Books self-help 0 3
-0.390536207987 Books reference 0 4
-0.361388375025 Books arts 0 5
-0.294644974838 Books travel 0 6
-0.271740556572 Books business 0 7
-0.451483367528 Children newborn 0 1
-0.395579858269 Children school-uniforms 0 2
-0.283308037489 Children toddlers 0 3
-0.818900225495 Electronics monitors 0 1
-0.803203772642 Electronics memory 0 2
-0.601671839290 Electronics audio 0 3
-0.561754670184 Electronics stereo 0 4
-0.539295360266 Electronics musical 0 5
-0.500535076467 Electronics televisions 0 6
-0.485984869243 Electronics karoke 0 7
-0.427238663642 Electronics dvd/vcr players 0 8
-0.373938894451 Electronics scanners 0 9
-0.453441805345 Home rugs 0 1
-0.426861349508 Home kids 0 2
-0.327256787408 Home decor 0 3
-0.231456207457 Home furniture 0 4
-0.223144558697 Home bedding 0 5
-0.552936914048 Jewelry costume 0 1
-0.479340075046 Jewelry jewelry boxes 0 2
-0.477787939030 Jewelry consignment 0 3
-0.466880015534 Jewelry pendants 0 4
-0.453849812674 Jewelry estate 0 5
-0.409295229944 Jewelry diamonds 0 6
-0.395230036306 Jewelry semi-precious 0 7
-0.355619262239 Jewelry custom 0 8
-0.297142264334 Jewelry gold 0 9
-0.177338006086 Jewelry mens watch 0 10
-0.560892409081 Men sports-apparel 0 1
-0.455523452563 Men shirts 0 2
-0.449096601845 Men pants 0 3
-0.445111999490 Men accessories 0 4
-0.500281860803 Music pop 0 1
-0.430407608267 Music country 0 2
-0.359006402586 Music classical 0 3
-0.387787805905 Shoes mens 0 1
-0.261783565849 Shoes womens 0 2
-0.740280536700 Sports fishing 0 1
-0.456764107705 Sports sailing 0 2
-0.325190591878 Sports guns 0 3
-0.466266877787 Women swimwear 0 1
-0.398132007627 Women fragrances 0 2
-0.355443373145 Women maternity 0 3

query I
WITH web_v1 AS materialized
  (SELECT ws_item_sk item_sk,
          d_date,
          sum(sum(ws_sales_price)) OVER (PARTITION BY ws_item_sk
                                         ORDER BY d_date ROWS BETWEEN unbounded preceding AND CURRENT ROW) cume_sales
   FROM web_sales,
        date_dim
   WHERE ws_sold_date_sk=d_date_sk
     AND d_month_seq BETWEEN 1200 AND 1200+11
     AND ws_item_sk IS NOT NULL
   GROUP BY ws_item_sk,
            d_date),
     store_v1 AS materialized
  (SELECT ss_item_sk item_sk,
          d_date,
          sum(sum(ss_sales_price)) OVER (PARTITION BY ss_item_sk
                                         ORDER BY d_date ROWS BETWEEN unbounded preceding AND CURRENT ROW) cume_sales
   FROM store_sales,
        date_dim
   WHERE ss_sold_date_sk=d_date_sk
     AND d_month_seq BETWEEN 1200 AND 1200+11
     AND ss_item_sk IS NOT NULL
   GROUP BY ss_item_sk,
            d_date)
SELECT *
FROM
  (SELECT item_sk,
          d_date,
          web_sales,
          store_sales,
          max(web_sales) OVER (PARTITION BY item_sk
                               ORDER BY d_date ROWS BETWEEN unbounded preceding AND CURRENT ROW) web_cumulative,
                              max(store_sales) OVER (PARTITION BY item_sk
                                                     ORDER BY d_date ROWS BETWEEN unbounded preceding AND CURRENT ROW) store_cumulative
   FROM
     (SELECT CASE
                 WHEN web.item_sk IS NOT NULL THEN web.item_sk
                 ELSE store.item_sk
             END item_sk,
             CASE
                 WHEN web.d_date IS NOT NULL THEN web.d_date
                 ELSE store.d_date
             END d_date,
             web.cume_sales web_sales,
             store.cume_sales store_sales
      FROM web_v1 web
      FULL OUTER JOIN store_v1 store ON (web.item_sk = store.item_sk
                                         AND web.d_date = store.d_date))x)y
WHERE web_cumulative > store_cumulative
ORDER BY item_sk NULLS FIRST,
         d_date NULLS FIRST
LIMIT 100;
----
1 2000-01-03 49.67 0.20 49.67 0.20
7 2000-01-23 181.88 NULL 181.88 146.39
7 2000-02-04 239.65 NULL 239.65 230.60
8 2000-01-23 74.99 NULL 74.99 63.42
11 2000-01-23 223.53 NULL 223.53 100.29
11 2000-01-28 NULL 170.80 223.53 170.80
11 2000-02-04 278.55 NULL 278.55 170.80
11 2000-02-07 NULL 250.35 278.55 250.35
11 2000-02-27 NULL 263.55 278.55 263.55
11 2000-05-25 457.11 NULL 457.11 451.20
11 2000-05-30 516.04 NULL 516.04 451.20
11 2000-06-13 NULL 455.49 516.04 455.49
13 2000-01-06 NULL 38.27 215.37 38.27
13 2000-01-08 NULL 110.91 215.37 110.91
13 2000-01-12 NULL 153.25 215.37 153.25
13 2000-02-28 273.82 NULL 273.82 246.46
13 2000-03-01 NULL 256.92 273.82 256.92
19 2000-01-06 NULL 0.00 97.20 0.00
19 2000-01-13 NULL 45.54 97.20 45.54
19 2000-01-28 NULL 45.54 97.20 45.54
19 2000-02-07 NULL 55.97 97.20 55.97
19 2000-02-28 113.06 NULL 113.06 55.97
20 2000-01-23 77.39 NULL 77.39 29.75
20 2000-05-30 399.35 NULL 399.35 373.70
23 2000-02-02 14.07 NULL 14.07 3.21
23 2000-02-20 NULL 13.96 14.07 13.96
32 2000-02-04 126.47 NULL 126.47 52.95
38 2000-01-07 NULL 27.58 34.37 27.58
38 2000-01-17 NULL 30.75 34.37 30.75
38 2000-02-28 147.32 NULL 147.32 82.84
38 2000-03-11 NULL 107.74 147.32 107.74
44 2000-02-01 105.14 NULL 105.14 95.40
47 2000-01-03 204.35 NULL 204.35 122.62
47 2000-01-06 NULL 124.16 204.35 124.16
47 2000-01-13 NULL 124.98 204.35 124.98
47 2000-01-20 NULL 133.97 204.35 133.97
50 2000-01-06 NULL 97.72 148.98 97.72
50 2000-01-19 NULL 104.26 148.98 104.26
50 2000-01-29 169.86 NULL 169.86 104.26
50 2000-02-08 NULL 149.80 169.86 149.80
50 2000-02-16 NULL 151.55 169.86 151.55
50 2000-02-28 234.42 NULL 234.42 192.02
50 2000-03-01 NULL 193.26 234.42 193.26
50 2000-03-10 NULL 194.62 234.42 194.62
50 2000-04-19 NULL 216.06 234.42 216.06
50 2000-04-25 273.25 NULL 273.25 216.06
50 2000-04-29 NULL 217.00 273.25 217.00
50 2000-05-02 278.87 NULL 278.87 217.00
50 2000-05-15 433.18 NULL 433.18 291.83
50 2000-05-22 NULL 312.96 433.18 312.96
50 2000-06-10 NULL 321.30 433.18 321.30
50 2000-06-26 NULL 377.76 433.18 377.76
50 2000-06-30 NULL 404.21 433.18 404.21
53 2000-02-02 62.47 NULL 62.47 59.57
56 2000-01-06 NULL 11.41 110.40 11.41
62 2000-01-28 NULL 2.29 86.61 2.29
62 2000-01-29 177.44 NULL 177.44 2.29
62 2000-02-05 NULL 15.60 177.44 15.60
62 2000-02-07 NULL 28.81 177.44 28.81
62 2000-02-21 NULL 54.49 177.44 54.49
62 2000-02-24 NULL 58.26 177.44 58.26
62 2000-02-28 189.05 NULL 189.05 58.26
62 2000-03-05 NULL 63.19 189.05 63.19
62 2000-03-26 NULL 72.24 189.05 72.24
62 2000-04-22 NULL 76.07 189.05 76.07
62 2000-04-25 356.03 NULL 356.03 76.07
62 2000-04-28 NULL 159.79 356.03 159.79
62 2000-05-01 NULL 161.04 356.03 161.04
62 2000-05-02 365.24 NULL 365.24 161.04
62 2000-05-11 NULL 212.80 365.24 212.80
62 2000-05-15 393.79 NULL 393.79 212.80
62 2000-05-22 NULL 253.38 393.79 253.38
62 2000-06-19 NULL 355.16 393.79 355.16
62 2000-06-26 NULL 369.20 393.79 369.20
89 2000-01-03 156.24 NULL 156.24 47.35
89 2000-01-06 NULL 72.24 156.24 72.24
89 2000-01-13 NULL 142.00 156.24 142.00
91 2000-01-02 99.10 66.50 99.10 66.50
91 2000-01-06 NULL 96.22 99.10 96.22
92 2000-02-02 80.98 NULL 80.98 55.60
98 2000-02-28 180.36 NULL 180.36 166.58
103 2000-01-23 97.30 NULL 97.30 83.02
104 2000-02-01 52.42 NULL 52.42 19.47
107 2000-01-06 NULL 42.56 129.74 42.56
107 2000-01-08 NULL 68.81 129.74 68.81
107 2000-01-14 NULL 71.85 129.74 71.85
107 2000-03-02 148.85 77.43 148.85 77.43
107 2000-03-05 NULL 108.23 148.85 108.23
113 2000-01-06 NULL 29.89 86.14 29.89
113 2000-01-28 NULL 33.94 86.14 33.94
113 2000-02-05 NULL 38.93 86.14 38.93
113 2000-02-07 NULL 75.32 86.14 75.32
113 2000-02-28 122.39 NULL 122.39 103.94
113 2000-03-05 NULL 106.61 122.39 106.61
113 2000-03-26 NULL 108.17 122.39 108.17
121 2000-01-06 NULL 1.52 151.03 1.52
121 2000-01-12 NULL 23.71 151.03 23.71
121 2000-01-13 NULL 24.59 151.03 24.59
121 2000-01-21 NULL 104.74 151.03 104.74
121 2000-01-29 261.33 NULL 261.33 104.74

query I
WITH my_customers AS materialized
  (SELECT DISTINCT c_customer_sk,
                   c_current_addr_sk
   FROM
     (SELECT cs_sold_date_sk sold_date_sk,
             cs_bill_customer_sk customer_sk,
             cs_item_sk item_sk
      FROM catalog_sales
      UNION ALL SELECT ws_sold_date_sk sold_date_sk,
                       ws_bill_customer_sk customer_sk,
                       ws_item_sk item_sk
      FROM web_sales) cs_or_ws_sales,
        item,
        date_dim,
        customer
   WHERE sold_date_sk = d_date_sk
     AND item_sk = i_item_sk
     AND i_category = 'Women'
     AND i_class = 'maternity'
     AND c_customer_sk = cs_or_ws_sales.customer_sk
     AND d_moy = 12
     AND d_year = 1998 ),
     my_revenue AS
  (SELECT c_customer_sk,
          sum(ss_ext_sales_price) AS revenue
   FROM my_customers,
        store_sales,
        customer_address,
        store,
        date_dim
   WHERE c_current_addr_sk = ca_address_sk
     AND ca_county = s_county
     AND ca_state = s_state
     AND ss_sold_date_sk = d_date_sk
     AND c_customer_sk = ss_customer_sk
     AND d_month_seq BETWEEN
       (SELECT DISTINCT d_month_seq+1
        FROM date_dim
        WHERE d_year = 1998
          AND d_moy = 12) AND
       (SELECT DISTINCT d_month_seq+3
        FROM date_dim
        WHERE d_year = 1998
          AND d_moy = 12)
   GROUP BY c_customer_sk),
     segments AS
  (SELECT cast(round(revenue/50) AS int) AS SEGMENT
   FROM my_revenue)
SELECT SEGMENT,
       count(*) AS num_customers,
       SEGMENT*50 AS segment_base
FROM segments
GROUP BY SEGMENT
ORDER BY SEGMENT NULLS FIRST,
         num_customers NULLS FIRST,
         segment_base
LIMIT 100;
----

query I
WITH ss AS materialized
  (SELECT i_item_id,
          sum(ss_ext_sales_price) total_sales
   FROM store_sales,
        date_dim,
        customer_address,
        item
   WHERE i_item_id IN
       (SELECT i_item_id
        FROM item
        WHERE i_color IN ('slate',
                          'blanched',
                          'burnished'))
     AND ss_item_sk = i_item_sk
     AND ss_sold_date_sk = d_date_sk
     AND d_year = 2001
     AND d_moy = 2
     AND ss_addr_sk = ca_address_sk
     AND ca_gmt_offset = -5
   GROUP BY i_item_id),
     cs AS materialized
  (SELECT i_item_id,
          sum(cs_ext_sales_price) total_sales
   FROM catalog_sales,
        date_dim,
        customer_address,
        item
   WHERE i_item_id IN
       (SELECT i_item_id
        FROM item
        WHERE i_color IN ('slate',
                          'blanched',
                          'burnished'))
     AND cs_item_sk = i_item_sk
     AND cs_sold_date_sk = d_date_sk
     AND d_year = 2001
     AND d_moy = 2
     AND cs_bill_addr_sk = ca_address_sk
     AND ca_gmt_offset = -5
   GROUP BY i_item_id),
     ws AS materialized
  (SELECT i_item_id,
          sum(ws_ext_sales_price) total_sales
   FROM web_sales,
        date_dim,
        customer_address,
        item
   WHERE i_item_id IN
       (SELECT i_item_id
        FROM item
        WHERE i_color IN ('slate',
                          'blanched',
                          'burnished'))
     AND ws_item_sk = i_item_sk
     AND ws_sold_date_sk = d_date_sk
     AND d_year = 2001
     AND d_moy = 2
     AND ws_bill_addr_sk = ca_address_sk
     AND ca_gmt_offset = -5
   GROUP BY i_item_id)
SELECT i_item_id,
       sum(total_sales) total_sales
FROM
  (SELECT *
   FROM ss
   UNION ALL SELECT *
   FROM cs
   UNION ALL SELECT *
   FROM ws) tmp1
GROUP BY i_item_id
ORDER BY total_sales  NULLS FIRST,
         i_item_id NULLS FIRST
LIMIT 100;
----

query I
WITH ss_items AS materialized
  (SELECT i_item_id item_id,
          sum(ss_ext_sales_price) ss_item_rev
   FROM store_sales,
        item,
        date_dim
   WHERE ss_item_sk = i_item_sk
     AND d_date IN
       (SELECT d_date
        FROM date_dim
        WHERE d_week_seq =
            (SELECT d_week_seq
             FROM date_dim
             WHERE d_date = '2000-01-03'))
     AND ss_sold_date_sk = d_date_sk
   GROUP BY i_item_id),
     cs_items AS materialized
  (SELECT i_item_id item_id,
          sum(cs_ext_sales_price) cs_item_rev
   FROM catalog_sales,
        item,
        date_dim
   WHERE cs_item_sk = i_item_sk
     AND d_date IN
       (SELECT d_date
        FROM date_dim
        WHERE d_week_seq =
            (SELECT d_week_seq
             FROM date_dim
             WHERE d_date = '2000-01-03'))
     AND cs_sold_date_sk = d_date_sk
   GROUP BY i_item_id),
     ws_items AS materialized
  (SELECT i_item_id item_id,
          sum(ws_ext_sales_price) ws_item_rev
   FROM web_sales,
        item,
        date_dim
   WHERE ws_item_sk = i_item_sk
     AND d_date IN
       (SELECT d_date
        FROM date_dim
        WHERE d_week_seq =
            (SELECT d_week_seq
             FROM date_dim
             WHERE d_date = '2000-01-03'))
     AND ws_sold_date_sk = d_date_sk
   GROUP BY i_item_id)
SELECT ss_items.item_id,
       ss_item_rev,
       ss_item_rev/((ss_item_rev+cs_item_rev+ws_item_rev)/3) * 100 ss_dev,
       cs_item_rev,
       cs_item_rev/((ss_item_rev+cs_item_rev+ws_item_rev)/3) * 100 cs_dev,
       ws_item_rev,
       ws_item_rev/((ss_item_rev+cs_item_rev+ws_item_rev)/3) * 100 ws_dev,
       (ss_item_rev+cs_item_rev+ws_item_rev)/3 average
FROM ss_items,
     cs_items,
     ws_items
WHERE ss_items.item_id=cs_items.item_id
  AND ss_items.item_id=ws_items.item_id
  AND ss_item_rev BETWEEN 0.9 * cs_item_rev AND 1.1 * cs_item_rev
  AND ss_item_rev BETWEEN 0.9 * ws_item_rev AND 1.1 * ws_item_rev
  AND cs_item_rev BETWEEN 0.9 * ss_item_rev AND 1.1 * ss_item_rev
  AND cs_item_rev BETWEEN 0.9 * ws_item_rev AND 1.1 * ws_item_rev
  AND ws_item_rev BETWEEN 0.9 * ss_item_rev AND 1.1 * ss_item_rev
  AND ws_item_rev BETWEEN 0.9 * cs_item_rev AND 1.1 * cs_item_rev
ORDER BY ss_items.item_id NULLS FIRST,
         ss_item_rev NULLS FIRST
LIMIT 100;
----

query I
WITH year_total AS materialized
  (SELECT c_customer_id customer_id,
          c_first_name customer_first_name,
          c_last_name customer_last_name,
          d_year AS year_,
          sum(ss_net_paid) year_total,
          's' sale_type
   FROM customer,
        store_sales,
        date_dim
   WHERE c_customer_sk = ss_customer_sk
     AND ss_sold_date_sk = d_date_sk
     AND d_year IN (2001,
                    2001+1)
   GROUP BY c_customer_id,
            c_first_name,
            c_last_name,
            d_year
   UNION ALL SELECT c_customer_id customer_id,
                    c_first_name customer_first_name,
                    c_last_name customer_last_name,
                    d_year AS year_,
                    sum(ws_net_paid) year_total,
                    'w' sale_type
   FROM customer,
        web_sales,
        date_dim
   WHERE c_customer_sk = ws_bill_customer_sk
     AND ws_sold_date_sk = d_date_sk
     AND d_year IN (2001,
                    2001+1)
   GROUP BY c_customer_id,
            c_first_name,
            c_last_name,
            d_year)
SELECT t_s_secyear.customer_id,
       t_s_secyear.customer_first_name,
       t_s_secyear.customer_last_name
FROM year_total t_s_firstyear,
     year_total t_s_secyear,
     year_total t_w_firstyear,
     year_total t_w_secyear
WHERE t_s_secyear.customer_id = t_s_firstyear.customer_id
  AND t_s_firstyear.customer_id = t_w_secyear.customer_id
  AND t_s_firstyear.customer_id = t_w_firstyear.customer_id
  AND t_s_firstyear.sale_type = 's'
  AND t_w_firstyear.sale_type = 'w'
  AND t_s_secyear.sale_type = 's'
  AND t_w_secyear.sale_type = 'w'
  AND t_s_firstyear.year_ = 2001
  AND t_s_secyear.year_ = 2001+1
  AND t_w_firstyear.year_ = 2001
  AND t_w_secyear.year_ = 2001+1
  AND t_s_firstyear.year_total > 0
  AND t_w_firstyear.year_total > 0
  AND CASE
          WHEN t_w_firstyear.year_total > 0 THEN t_w_secyear.year_total / t_w_firstyear.year_total
          ELSE NULL
      END > CASE
                WHEN t_s_firstyear.year_total > 0 THEN t_s_secyear.year_total / t_s_firstyear.year_total
                ELSE NULL
            END
ORDER BY 1 NULLS FIRST
LIMIT 100;
----

# Q95
query I
WITH ws_wh AS materialized
  (SELECT ws1.ws_order_number,
          ws1.ws_warehouse_sk wh1,
          ws2.ws_warehouse_sk wh2
   FROM web_sales ws1,
        web_sales ws2
   WHERE ws1.ws_order_number = ws2.ws_order_number
     AND ws1.ws_warehouse_sk <> ws2.ws_warehouse_sk)
SELECT count(DISTINCT ws_order_number) AS "order count" ,
       sum(ws_ext_ship_cost) AS "total shipping cost" ,
       sum(ws_net_profit) AS "total net profit"
FROM web_sales ws1 ,
     date_dim ,
     customer_address ,
     web_site
WHERE d_date BETWEEN '1999-02-01' AND cast('1999-04-02' AS date)
  AND ws1.ws_ship_date_sk = d_date_sk
  AND ws1.ws_ship_addr_sk = ca_address_sk
  AND ca_state = 'IL'
  AND ws1.ws_web_site_sk = web_site_sk
  AND web_company_name = 'pri'
  AND ws1.ws_order_number IN
    (SELECT ws_order_number
     FROM ws_wh)
  AND ws1.ws_order_number IN
    (SELECT wr_order_number
     FROM web_returns,
          ws_wh
     WHERE wr_order_number = ws_wh.ws_order_number)
ORDER BY count(DISTINCT ws_order_number)
LIMIT 100;
----
0 NULL NULL